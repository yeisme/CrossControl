name: C++23 Multi-Compiler CI (CMake Workflow)

on:
  push:
    branches: [master, develop, feature/*]
  pull_request:
    branches: [master, develop]
  # 手动触发工作流
  workflow_dispatch:

jobs:
  # Linux 平台：GCC/Clang 构建（复用CMake workflow presets）
  linux-build:
    name: Linux | ${{ matrix.workflow-preset }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        workflow-preset: ["clang-release-workflow"]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Clang (C++23 support)
        run: |
          # 安装基础依赖
          sudo apt-get update
          sudo apt-get install -y ninja-build libgl1-mesa-dev libxcb-xinerama0 dpkg-dev software-properties-common

          # 安装Clang 20
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y libc++-20-dev libc++abi-20-dev
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100
          clang++ --version  # 验证版本

      - uses: lukka/get-cmake@latest

      - name: Debug aqtinstall availability
        run: |
          python3 -m pip install --upgrade pip aqtinstall
          echo "--- Python and aqt versions ---"
          python3 --version
          python3 -m pip show aqtinstall || true
          echo "--- list available architectures for Qt 6.8.3 ---"
          python3 -m aqt list-qt linux desktop 6.8.3 || true
          echo "--- list available architectures (all) ---"
          python3 -m aqt list-qt linux desktop --all || true

      - name: Set up Qt 6
        id: install-qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.8.3"
          host: "linux"
          arch: "gcc_64"
          cache: true
          # 明确指定需要的Qt组件，解决qt_base找不到的问题
          components: >-
            qtbase          # 包含Core/Widgets/Network
            qttools         # 包含LinguistTools
            qtmultimedia    # 包含Multimedia

      - name: Clone vcpkg (Linux)
        run: |
          if [ ! -d "${{ github.workspace }}/vcpkg" ]; then
            git clone --depth 1 https://github.com/microsoft/vcpkg.git "${{ github.workspace }}/vcpkg"
          else
            echo "vcpkg already exists, skipping clone"
          fi

      - name: Bootstrap vcpkg (Linux)
        shell: bash
        run: |
          chmod +x "${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh"
          "${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh"

      - name: Install vcpkg packages (global mode, Linux)
        shell: bash
        run: |
          VCPKG_BIN="${{ github.workspace }}/vcpkg/vcpkg"
          echo "Installing fmt and spdlog (global mode) via $VCPKG_BIN"
          $VCPKG_BIN install fmt:x64-linux spdlog:x64-linux --recurse
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Run CMake workflow (use lukka/run-cmake@v10)
        uses: lukka/run-cmake@v10
        with:
          workflowPreset: ${{ matrix.workflow-preset }}
        env:
          QT6_DIR: ${{ steps.install-qt.outputs.install_prefix }}
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_CXX_STANDARD: 23 # 强制C++23标准

      - name: Upload release artifacts
        if: ${{ contains(matrix.workflow-preset, 'release') }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.workflow-preset }}-artifacts
          path: ${{ github.workspace }}/clang-release/*

  # Windows 平台：MSVC 构建（复用CMake workflow presets）
  windows-build:
    name: Windows | ${{ matrix.workflow-preset }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        workflow-preset: ["msvc-release-workflow"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Visual Studio (支持C++23)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: "latest" # 使用最新VS，默认支持C++23

      - name: Set up Qt 6
        id: install-qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.8.3"
          host: "windows"
          arch: "win64_msvc2022_64"
          cache: true
          components: >-
            qtbase
            qtdeclarative
            qttools
            qtmultimedia

      - name: Debug Qt installation (Windows)
        if: always()
        shell: pwsh
        run: |
          $prefix = "${{ steps.install-qt.outputs.install_prefix }}"
          Write-Host "install-qt install_prefix: $prefix"
          if (-not $prefix) { Write-Host "install_prefix is empty"; exit 0 }
          Write-Host "Listing top-level of install prefix:"
          Get-ChildItem -Path $prefix | ForEach-Object { Write-Host $_.FullName }
          $cmakeDir = Join-Path $prefix "lib\cmake"
          Write-Host "Checking lib\cmake contents: $cmakeDir"
          if (Test-Path $cmakeDir) {
            Get-ChildItem -Path $cmakeDir -Recurse -Depth 2 | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "cmake dir does not exist: $cmakeDir"
          }
          $multimediaCfg = Join-Path $cmakeDir "Qt6Multimedia\Qt6MultimediaConfig.cmake"
          if (Test-Path $multimediaCfg) { Write-Host "FOUND: Qt6MultimediaConfig.cmake -> $multimediaCfg" } else { Write-Host "MISSING: Qt6MultimediaConfig.cmake ($multimediaCfg)" }

      - name: Clone vcpkg (Windows)
        shell: pwsh
        run: |
          $vcpkgDir = "${{ github.workspace }}\vcpkg"
          if (-not (Test-Path $vcpkgDir)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg.git $vcpkgDir
          } else {
            Write-Host "vcpkg already exists, skipping clone"
          }

      - name: Bootstrap vcpkg (Windows)
        shell: pwsh
        run: |
          $bootstrap = "${{ github.workspace }}\vcpkg\bootstrap-vcpkg.bat"
          Write-Host "Running bootstrap: $bootstrap"
          & $bootstrap

      - name: Install vcpkg packages (global mode, Windows)
        shell: pwsh
        run: |
          $vcpkg = "${{ github.workspace }}\vcpkg\vcpkg.exe"
          Write-Host "Installing fmt and spdlog (global mode) via $vcpkg"
          & $vcpkg install fmt:x64-windows spdlog:x64-windows --recurse
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg

      - name: Run CMake workflow (use lukka/run-cmake@v10)
        uses: lukka/run-cmake@v10
        with:
          workflowPreset: ${{ matrix.workflow-preset }}
        env:
          QT6_DIR: ${{ steps.install-qt.outputs.install_prefix }}
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_CXX_STANDARD: 23

      - name: Upload release artifacts
        if: ${{ contains(matrix.workflow-preset, 'release') }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.workflow-preset }}-artifacts
          path: ${{ github.workspace }}/msvc-release/*
