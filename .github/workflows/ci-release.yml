name: C++23 Multi-Compiler CI (CMake Workflow)

on:
  push:
    branches: [master, develop, feature/*]
  pull_request:
    branches: [master, develop]
  # 手动触发工作流
  workflow_dispatch:

jobs:
  # Linux 平台：GCC/Clang 构建（复用CMake workflow presets）
  linux-build:
    name: Linux | ${{ matrix.workflow-preset }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        workflow-preset: ["gcc-release-workflow", "clang-release-workflow"]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install latest compilers (C++23 support)
        run: |
          # 安装基础依赖
          sudo apt-get update
          sudo apt-get install -y ninja-build libgl1-mesa-dev libxcb-xinerama0 dpkg-dev software-properties-common

          # 根据工作流判断编译器类型
          if [[ "${{ matrix.workflow-preset }}" == *"gcc"* ]]; then
            # 安装GCC 14
            sudo add-apt-repository ppa:ubuntu-toolchain-r/ppa -y
            sudo apt-get update
            sudo apt-get install -y gcc-14 g++-14
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
            g++ --version  # 验证版本
          else
            # 安装Clang 20
            wget https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            sudo ./llvm.sh 20
            sudo apt-get install -y libc++-20-dev libc++abi-20-dev
            sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 100
            sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100
            clang++ --version  # 验证版本
          fi

      - uses: lukka/get-cmake@latest

      - name: Set up Qt 6
        id: install-qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.8.3"
          host: "linux"
          arch: "gcc_64"
          cache: true
          # 明确指定需要的Qt组件，解决qt_base找不到的问题
          components: >-
            qtbase          # 包含Core/Widgets/Network
            qttools         # 包含LinguistTools
            qtmultimedia    # 包含Multimedia

      - name: Clone vcpkg (Linux)
        run: |
          if [ ! -d "${{ github.workspace }}/vcpkg" ]; then
            git clone --depth 1 https://github.com/microsoft/vcpkg.git "${{ github.workspace }}/vcpkg"
          else
            echo "vcpkg already exists, skipping clone"
          fi

      - name: Bootstrap vcpkg (Linux)
        shell: bash
        run: |
          chmod +x "${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh"
          "${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh"

      - name: Install vcpkg packages (global mode, Linux)
        shell: bash
        run: |
          VCPKG_BIN="${{ github.workspace }}/vcpkg/vcpkg"
          echo "Installing fmt and spdlog (global mode) via $VCPKG_BIN"
          $VCPKG_BIN install fmt:x64-linux spdlog:x64-linux --recurse
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Run CMake workflow (use lukka/run-cmake@v10)
        uses: lukka/run-cmake@v10
        with:
          workflowPreset: ${{ matrix.workflow-preset }}
        env:
          QT6_DIR: ${{ steps.install-qt.outputs.install_prefix }}
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_CXX_STANDARD: 23 # 强制C++23标准

      - name: Upload release artifacts
        if: ${{ contains(matrix.workflow-preset, 'release') }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.workflow-preset }}-artifacts
          path: ${{ github.workspace }}/${{ contains(matrix.workflow-preset, 'gcc') && 'gcc-release' || 'clang-release' }}/*

  # Windows 平台：MSVC 构建（复用CMake workflow presets）
  windows-build:
    name: Windows | ${{ matrix.workflow-preset }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        workflow-preset: ["msvc-release-workflow"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Visual Studio (支持C++23)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: "latest" # 使用最新VS，默认支持C++23

      - name: Set up Qt 6
        id: install-qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.8.3"
          host: "windows"
          arch: "win64_msvc2022_64"
          cache: true
          components: >-
            qtbase
            qtdeclarative
            qttools

      - name: Clone vcpkg (Windows)
        shell: pwsh
        run: |
          $vcpkgDir = "${{ github.workspace }}\vcpkg"
          if (-not (Test-Path $vcpkgDir)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg.git $vcpkgDir
          } else {
            Write-Host "vcpkg already exists, skipping clone"
          }

      - name: Bootstrap vcpkg (Windows)
        shell: pwsh
        run: |
          $bootstrap = "${{ github.workspace }}\vcpkg\bootstrap-vcpkg.bat"
          Write-Host "Running bootstrap: $bootstrap"
          & $bootstrap

      - name: Install vcpkg packages (global mode, Windows)
        shell: pwsh
        run: |
          $vcpkg = "${{ github.workspace }}\vcpkg\vcpkg.exe"
          Write-Host "Installing fmt and spdlog (global mode) via $vcpkg"
          & $vcpkg install fmt:x64-windows spdlog:x64-windows --recurse
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg

      - name: Run CMake workflow (use lukka/run-cmake@v10)
        uses: lukka/run-cmake@v10
        with:
          workflowPreset: ${{ matrix.workflow-preset }}
        env:
          QT6_DIR: ${{ steps.install-qt.outputs.install_prefix }}
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          CMAKE_CXX_STANDARD: 23

      - name: Upload release artifacts
        if: ${{ contains(matrix.workflow-preset, 'release') }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.workflow-preset }}-artifacts
          path: ${{ github.workspace }}/msvc-release/*
